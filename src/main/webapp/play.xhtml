<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="WEB-INF/templates/template-nav.xhtml">

        <ui:define name="head"><title><h:outputText value="#{messages.appName}"/></title></ui:define>

        <ui:define name="content">
            <div class="row">
                <div class="col-md-8">
                    <h2><h:outputText value="#{gamePlayController.game.name}"/></h2>

                    <p>
                        <h:form id="refreshForm">
                            <h:commandLink action="#{gamePlayController.clearRoundData}" styleClass="btn btn-info">
                                <i class="fa fa-refresh"></i> | <h:outputText value="#{messages.refresh}"/>
                            </h:commandLink>
                        </h:form>
                    </p>

                    <div class="card blackCard">
                        <div class="title">
                            <h:outputText value="#{gamePlayController.game.currentRound.blackCard.text}"/>
                        </div>
                        <h:panelGroup styleClass="pick" rendered="#{gamePlayController.game.currentRound.blackCard.playCount gt 1}">
                            <div>
                                <h:outputText value="#{messages.play}"/> <span class="roundNumber"><h:outputText value="#{gamePlayController.game.currentRound.blackCard.playCount}"/></span>
                            </div>
                            <h:panelGroup rendered="#{gamePlayController.game.currentRound.blackCard.playCount gt 2}" layout="block">
                                <h:outputText value="#{messages.draw}"/> <span class="roundNumber">2</span>
                            </h:panelGroup>
                        </h:panelGroup>
                    </div>

                    <h:panelGroup rendered="#{gamePlayController.playedMove}">
                        <ui:repeat value="#{gamePlayController.myPlay.cardsAsList}" var="card">
                            <div class="card whiteCard">
                                <div class="title">
                                    <h:outputText value="#{card.text}"/>
                                </div>
                            </div>
                        </ui:repeat>
                    </h:panelGroup>

                    <h:form id="removeCardForm">
                        <ui:repeat value="#{gamePlayController.pendingModel}" var="card">
                            <h:commandLink action="#{gamePlayController.removeCard}">
                                <div class="card whiteCard">
                                    <div class="title">
                                        <h:outputText value="#{card.text}"/>
                                    </div>
                                </div>
                            </h:commandLink>
                        </ui:repeat>
                    </h:form>
                </div>

                <h:panelGroup rendered="#{gamePlayController.previousRoundAvailable}">
                    <div class="col-md-4 previous-round">
                        <h3><h:outputText value="#{messages.previousRound}"/></h3>

                        <p class="winner">
                            <h:outputText value="#{messages.winner}: "/>
                            <img src="#{gamePlayController.previousRoundWinner.imageUrl}" alt="avatar"/>
                            <h:outputText value=" #{gamePlayController.previousRoundWinner.fullName}"/>
                        </p>

                        <dl>
                            <ui:repeat value="#{gamePlayController.previousRoundPlays}" var="play">
                                <dt><img src="#{play.player.user.imageUrl}" alt="avatar"/> <h:outputText value="#{play.player.user.fullName}: "/></dt>
                                <dd><h:outputText value="#{gamePlayController.previousRoundPlayText}"/></dd>
                            </ui:repeat>
                        </dl>
                    </div>
                </h:panelGroup>

                <h:panelGroup rendered="#{!gamePlayController.czar and !gamePlayController.playedMove}">
                    <div class="col-md-12">
                        <h:form id="playCardForm">
                            <ui:repeat value="#{gamePlayController.myHand}" var="card">
                                <h:commandLink action="#{gamePlayController.playCard}"  rendered="#{gamePlayController.canPlay and !gamePlayController.alreadyPlayed}">
                                    <div class="card whiteCard">
                                        <div class="title">
                                            <h:outputText value="#{card.text}"/>
                                        </div>
                                    </div>
                                </h:commandLink>
                            </ui:repeat>

                            <h:panelGroup rendered="#{gamePlayController.canSubmit}">
                                <p>
                                    <h:commandLink action="#{gamePlayController.commitPlay}" styleClass="btn btn-info">
                                        <i class="fa fa-upload"></i> | <h:outputText value="#{messages.playSelectedCards}"/>
                                    </h:commandLink>
                                </p>
                            </h:panelGroup>
                        </h:form>
                    </div>
                </h:panelGroup>

                <h:panelGroup rendered="#{gamePlayController.czar}">
                    <div class="col-md-12">
                        <h:form id="votingForm">
                            <ui:repeat value="#{gamePlayController.plays}" var="play">
                                <div class="card blackCard">
                                    <div class="title">
                                        <h:outputText value="#{gamePlayController.play}"/>
                                    </div>

                                    <h:panelGroup styleClass="pick" layout="block" rendered="#{gamePlayController.allPlayed}">
                                        <h:commandLink action="#{gamePlayController.selectWinner}" styleClass="btn btn-info">
                                            <i class="fa fa-thumbs-o-up"></i> | <h:outputText value="#{messages.winner}"/>
                                        </h:commandLink>
                                    </h:panelGroup>
                                </div>
                            </ui:repeat>
                        </h:form>
                    </div>
                </h:panelGroup>
            </div>
        </ui:define>

        <ui:define name="scripts">
            <script language="javascript" type="text/javascript">
                $(function() {
                    var socket = new SockJS("/wwa-1.0/game");
                    var stompClient = Stomp.over(socket);
                    stompClient.connect('fred', 'fred', function() {
                        stompClient.subscribe('/topic/game/#{gamePlayController.gameId}', function(message) {
                            if ($('#votingForm').size() != 0 &amp;&amp; message.body == '"PLAYED"') {
                                $('#refreshForm .btn').click();
                            } else if (message.body == '"JUDGED"') {
                                $('#refreshForm .btn').click();
                            }
                        })
                    });
                });
            </script>
        </ui:define>
    </ui:composition>

</html>