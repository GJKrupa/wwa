<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="templates/template-nav.xhtml">
        <ui:define name="head">
            <title><h:outputText value="#{messages.appName}"/></title>
            <h:outputScript library="app" name="js/index.js"/>
            <script language="javascript" type="text/javascript">
                var userId = #{gameManagerController.user.id};
            </script>

        </ui:define>

        <ui:define name="content">

            <ul class="nav nav-tabs">
                <li class="active"><a href="#myGames" data-toggle="tab">Mine</a></li>
                <li><a href="#openGames" data-toggle="tab">Available</a></li>
                <li><a href="#createGame" data-toggle="tab">Create</a></li>
            </ul>

            <div class="tab-content" ng-controller="MyGamesController as gamesController" id="topLevel">


                <div class="tab-pane active" id="myGames">
                    <h2><h:outputText value="#{messages.myGames}"/></h2>
                    <h:form id="myGame">

                        <ul class="list-group">
                            <li ng-repeat="game in gamesController.myGames" class="list-group-item">
                                <span class="label label-success pull-right" ng-if="game.yourTurn">
                                    <h:outputText value="#{messages.yourTurn}"/>
                                </span>
                                <h4 class="list-group-item-heading">{{game.name}}</h4>
                                <p class="list-group-item-text">
                                    <h:outputText value="#{messages.owner}"/>:
                                    <span ng-if="!game.myGame">{{game.owner}}</span>
                                    <span ng-if="game.myGame"><h:outputText value="#{messages.me}"/></span>
                                </p>

                                <p>
                                    <h:outputText value="#{messages.players}"/>:
                                </p>

                                <ul class="userList">
                                    <li ng-repeat="player in game.players">
                                        <img src="{{player.avatarUrl}}" alt="avatar"/> {{player.name}}: {{player.score}}
                                    </li>
                                </ul>

                                <p>
                                    <a href="play.xhtml?id={{game.id}}" class="btn btn-info btn-block" ng-if="game.canPlay">
                                        <i class="fa fa-folder-open"></i> | <h:outputText value="#{messages.open}"/>
                                    </a>

                                    <a ng-click="gamesController.startGame(game.id)" class="btn btn-success btn-block" ng-if="game.canStart">
                                        <i class="fa fa-check-circle"></i> | <h:outputText value="#{messages.start}"/>
                                    </a>
                                </p>
                            </li>
                        </ul>
                    </h:form>
                </div>

                <div class="tab-pane" id="openGames">
                    <h2><h:outputText value="#{messages.availableGames}"/></h2>
                    <h:form id="openGame">
                        <div class="list-group">
                            <div class="list-group-item" ng-repeat="game in gamesController.openGames">
                                <span class="badge">{{game.players.length}}</span>
                                <h4 class="list-group-item-heading">{{game.name}}</h4>
                                <p>
                                    <h:outputText value="#{messages.owner}"/>: {{game.owner}}
                                </p>
                                <p>
                                    <a ng-click="gamesController.joinGame(game.id)" class="btn btn-info btn-block">
                                        <i class="fa fa-users"></i> | <h:outputText value="#{messages.join}"/>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </h:form>
                </div>

                <div class="tab-pane" id="createGame">
                    <h2><h:outputText value="#{messages.createNewGame}"/></h2>
                    <div class="form-group">
                        <label for="gameName"><h:outputText value="#{messages.name}"/></label>
                        <input id="gameName" class="form-control" ng-model="gamesController.gameName"/>
                    </div>
                    <a ng-click="gamesController.createGame()" class="btn btn-info">
                        <i class="fa fa-plus"></i> | <h:outputText value="#{messages.createGame}"/>
                    </a>
                </div>

            </div>

        </ui:define>

        <ui:define name="scripts">
            <script language="javascript" type="text/javascript">
                $(function() {
                    var socket = new SockJS("/wwa-1.0/game");
                    var stompClient = Stomp.over(socket);
                    stompClient.connect('fred', 'fred', function() {
                        stompClient.subscribe('/topic/user/#{gameManagerController.user.id}', function(message) {
                            notification = JSON.parse(message.body);
                            var gamesController = angular.element(document.getElementById('topLevel')).scope().gamesController;
                            gamesController.handleNotification(notification);
                        });
                        stompClient.subscribe('/topic/user/all', function(message) {
                            notification = JSON.parse(message.body);
                            var gamesController = angular.element(document.getElementById('topLevel')).scope().gamesController;
                            gamesController.handleNotification(notification);
                        });
                    });
                });
            </script>
        </ui:define>
    </ui:composition>

</html>