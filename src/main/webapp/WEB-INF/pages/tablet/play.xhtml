<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="templates/template-nav.xhtml">

        <ui:define name="head"><title><h:outputText value="#{messages.appName}"/></title></ui:define>

        <ui:define name="content">

            <h2><h:outputText value="#{gamePlayController.game.name}"/></h2>

            <h:form id="refreshForm">
                <h:commandLink action="#{gamePlayController.clearRoundData}" styleClass="ui-btn">
                    <i class="fa fa-refresh"></i> | <h:outputText value="#{messages.refresh}"/>
                </h:commandLink>
            </h:form>

            <div data-role="tabs" id="tabs">
                <div data-role="navbar">
                    <ul>
                        <li><a href="#currentRound" data-ajax="false"><h:outputText value="#{messages.currentRound}"/></a></li>
                        <li><a href="#previousRound" data-ajax="false"><h:outputText value="#{messages.previousRound}"/></a></li>
                    </ul>
                </div>

                <div id="currentRound" class="ui-body-d ui-content">

                    <h:panelGroup rendered="#{!gamePlayController.czar or !gamePlayController.allPlayed}" layout="block" styleClass="ui-body ui-body-a ui-corner-all ui-page-theme-b">

                        <p><h:outputText value="#{gamePlayController.pendingText}"/></p>

                        <hr />

                        <p><h:outputText value="#{messages.play} #{gamePlayController.game.currentRound.blackCard.playCount}"/></p>

                        <h:panelGroup rendered="#{gamePlayController.game.currentRound.blackCard.playCount gt 2}">
                            <p><h:outputText value="#{messages.draw} 2"/></p>
                        </h:panelGroup>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{!gamePlayController.playedMove and !gamePlayController.czar and (gamePlayController.canClear or !gamePlayController.canPlay)}" layout="block" styleClass="col-md-12">
                        <h:form id="commitForm">
                            <p>
                                <h:commandLink action="#{gamePlayController.commitPlay}" styleClass="ui-btn" rendered="#{!gamePlayController.canPlay}">
                                    <i class="fa fa-upload"></i> | <h:outputText value="#{messages.playSelectedCards}"/>
                                </h:commandLink>
                                <h:commandLink action="#{gamePlayController.clearPending}" styleClass="ui-btn" rendered="#{gamePlayController.canClear}">
                                    <i class="fa fa-trash-o"></i> | <h:outputText value="#{messages.clear}"/>
                                </h:commandLink>
                            </p>
                        </h:form>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{gamePlayController.canPlay and !gamePlayController.czar and !gamePlayController.playedMove}">
                        <h:form id="playCardForm">
                            <ul data-role="listview" data-inset="true">
                                <ui:repeat value="#{gamePlayController.myHand}" var="card">
                                    <h:panelGroup rendered="#{gamePlayController.canPlay and !gamePlayController.alreadyPlayed}">
                                        <li>
                                            <h:commandLink action="#{gamePlayController.playCard}">
                                                <h:outputText value="#{card.text}"/>
                                            </h:commandLink>
                                        </li>
                                    </h:panelGroup>
                                </ui:repeat>
                            </ul>
                        </h:form>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{gamePlayController.czar}" layout="block">
                        <h:form id="votingForm">
                            <ui:repeat value="#{gamePlayController.plays}" var="play">
                                <div>&nbsp;</div>
                                <div class="ui-body ui-body-a ui-corner-all ui-page-theme-b">
                                    <p>
                                        <h:outputText value="#{gamePlayController.play}"/>
                                    </p>

                                    <h:commandLink action="#{gamePlayController.selectWinner}" styleClass="ui-btn ui-btn-a" rendered="#{gamePlayController.allPlayed}">
                                        <i class="fa fa-thumbs-o-up"></i> | <h:outputText value="#{messages.winner}"/>
                                    </h:commandLink>
                                </div>
                            </ui:repeat>
                        </h:form>
                    </h:panelGroup>
                </div>

                <h:panelGroup id="previousRound" rendered="#{gamePlayController.previousRoundAvailable}" layout="block" styleClass="ui-body-d ui-content">

                    <h2><h:outputText value="#{messages.previousRound}"/></h2>

                    <ul data-role="listview" data-inset="true" class="previous-round-mobile">
                        <ui:repeat value="#{gamePlayController.players}" var="player">
                            <li class="list-group-item #{gamePlayController.playStyle}">

                                <div data-role="popup" id="popupPlayer#{player.id}" data-theme="a" data-overlay-theme="b" class="ui-content" >
                                    <p>
                                        <h:outputText value="#{gamePlayController.previousRoundPlayText}" rendered="#{gamePlayController.previousRoundPlayText != null}"/>

                                        <h:panelGroup rendered="#{gamePlayController.previousRoundPlayText == null}" styleClass="czar">
                                            <h:outputText value=" #{messages.czar} "/>
                                        </h:panelGroup>
                                    </p>
                                </div>

                                <a href="#popupPlayer#{player.id}" data-rel="popup" data-position-to="window" data-transition="pop">
                                    <img src="#{player.user.imageUrl}" alt="avatar" class="ui-corner-none"/>
                                    <h2>
                                        <strong><h:outputText value="#{player.user.fullName}: "/></strong>
                                        <span class="ui-li-count"><h:outputText value="#{player.score}"/></span>
                                    </h2>

                                    <h:outputText value="#{gamePlayController.previousRoundPlayText}" rendered="#{gamePlayController.previousRoundPlayText != null}"/>

                                    <h:panelGroup rendered="#{gamePlayController.previousRoundPlayText == null}" styleClass="czar">
                                        <h:outputText value=" #{messages.czar} "/>
                                    </h:panelGroup>
                                </a>
                            </li>
                        </ui:repeat>
                    </ul>
                </h:panelGroup>
            </div>

        </ui:define>

        <ui:define name="scripts">
            <script language="javascript" type="text/javascript">
                $(function() {
                    var socket = new SockJS("/wwa-1.0/game");
                    var stompClient = Stomp.over(socket);
                    stompClient.connect('fred', 'fred', function() {
                        stompClient.subscribe('/topic/game/#{gamePlayController.gameId}', function(message) {
                            if ($('#votingForm').size() != 0 &amp;&amp; message.body == '"PLAYED"') {
                                $('#refreshForm .ui-btn').click();
                            } else if (message.body == '"JUDGED"') {
                                $('#refreshForm .ui-btn').click();
                            }
                        })
                    });
                });
            </script>
        </ui:define>
    </ui:composition>

</html>